<!DOCTYPE html>
<html>
<style>
#container {
  width: 500px;
  height: 300px;
  position: relative;
  background: lightBlue;
  overflow: hidden;   /* clip anything outside the container */
}

#animate {
  width: 30px;
  height: 30px;
  position: absolute;
  bottom: 30px;
  left: 5px;
}
#floor1 {
    width: 45px;
    height: 30px;
    position: absolute;
    background: green;
    bottom: 0px;
    left: 0px;
}
#water1 {
    width: 110px;
    height: 10px;
    position: absolute;
    background: blue;
    bottom: 0px;
    left: 45px;
}
#floor2 {
    width: 40px;
    height: 30px;
    position: absolute;
    background: green;
    bottom: 0px;
    left: 155px;
}
#water2 {
    width: 110px;
    height: 10px;
    position: absolute;
    background: blue;
    bottom: 0px;
    left: 195px; 
}
#floor3 {
    width: 40px;
    height: 30px;
    position: absolute;
    background: green;
    bottom: 0px;
    left: 305px;
}
#water3 {
    width: 110px;
    height: 10px;
    position: absolute;
    background: blue;
    bottom: 0px;
    left: 345px; 
}
#floor4 {
    width: 45px;
    height: 30px;
    position: absolute;
    background: green;
    bottom: 0px;
    left: 455px; 
}
#statsDiv {
    position: absolute;
    top: 0px;
    right: 0px;
    text-align: right;
    line-height: 1.4;
    font-family: Arial, sans-serif;
    font-size: 14px;
    background: rgba(255,255,255,0.6);
    padding: 5px 8px;
    border-radius: 8px;
}

#floor1, #floor2, #floor3, #floor4 {
    z-index: 2;   /* floors above water but below wolf normally */
}
#water1, #water2, #water3 {
    z-index: 3;   /* water above floors */
}
#animate {
    z-index: 4;   /* wolf normally above everything */
}
</style>

<script src='../externalJS/gcf.js'></script>

<script>
// GLOBAL VARIABLES
var firstAttempt, reset=false, numCorrect=0, level=1;
var numberAttempted=0, numberCorrect=0, percentCorrect;
var a, a1, a2, b, c, m, n, greatestCommonFactor;
var jumpInProgress = false;
var problem; // what is to be displayed to the user
var jumpInProgress = false;
var celebrateID = null;


// CONSTANTS
var START_LEFT = 3;
var START_BOTTOM = 30;

// RESET POSITION
function resetPosition() {
  var animate = document.getElementById("animate");
  animate.style.left = START_LEFT + "px";
  animate.style.bottom = START_BOTTOM + "px";
  animate.style.zIndex = 4;
}

// LOAD PAGE
function loadPage() {
  document.getElementById('newButton').focus();
  document.getElementById('answerInput1').style.display='none';
  document.getElementById('answerInput2').style.display='none';
  document.getElementById('orSpan').style.display='none';
  document.getElementById('checkButton').style.display='none';
  getStats();
  resetPosition();
}

// QUADRATIC BEZIER ARC
function getArcY(progress, startY, endY, peak) {
  var t = progress;
  var oneMinusT = 1 - t;
  return (oneMinusT*oneMinusT*startY) + (2*oneMinusT*t*peak) + (t*t*endY);
}

function jump(distance, targetBottom, jumpHeight, fail) {
    if (jumpInProgress) return;
    jumpInProgress = true;

    stopCelebrationBounce(); // stop celebration if active

    var animate = document.getElementById("animate");
    var startLeft = parseFloat(animate.style.left) || START_LEFT;
    var startBottom = parseFloat(animate.style.bottom) || START_BOTTOM;

    var JUMP_SPEED = 1.3;
    var totalSteps = Math.round(distance / JUMP_SPEED);
    var stepX = distance / totalSteps;
    var peak = Math.max(startBottom, targetBottom) + jumpHeight;
    var counter = 0;

    document.getElementById('newButton').style.visibility = 'hidden';
    animate.style.zIndex = fail ? 1 : 4;

    var id = setInterval(function () {
        counter++;
        var progress = counter / totalSteps;

        animate.style.left = startLeft + stepX * counter + "px";
        animate.style.bottom =
            getArcY(progress, startBottom, targetBottom, peak) + "px";

        if (counter >= totalSteps) {
            clearInterval(id);
            animate.style.left = (startLeft + distance) + "px";
            animate.style.bottom = targetBottom + "px";
            jumpInProgress = false;

            // LEVEL-UP CHECK
            if (result === 'correct' && numCorrect === 3) {
                level++;
                numCorrect = 0;
                reset = true;

                document.getElementById('feedbackDiv').innerHTML =
                    'Correct! You have made it to Level ' + level + '!';

                getStats();
                startCelebrationBounce();

                document.getElementById('newButton').style.visibility = 'visible';
                document.getElementById('newButton').focus();
            } else {
                giveFeedback();
            }
        }
    }, 5);
} // end of jump()

function jumpSafe() {
    jump(150, 30, 40, false);
} // end of jumpSafe()

function jumpFail() {
    jump(110, 5, 30, true);
} // end of jumpFail()

// NEW PROBLEM
function newProblem() {
    if(jumpInProgress) return; // prevent clicks during jump

    getNewProblemDisplay();
    firstAttempt = true;
    if(reset) resetPosition();
    if(numCorrect>2) { resetPosition(); numCorrect=0; level++; }

    document.getElementById('statsDiv').innerHTML = 'Level: ' + level;
    
    getTwoRationalRoots();
    
    document.getElementById('answerInput1').focus();
}

function getTwoRationalRoots() {
    const validPairs = [
      [-6,1],[-6,-1],[-5,1],[-5,-1],[-4,1],[-4,-1],[-3,1],[-3,2],[-3,-1],[-3,-2],
      [-2,1],[-2,2],[-2,-1],[-2,-2],
      [-1,1],[-1,2],[-1,3],[-1,4],[-1,5],[-1,6],
      [1,1],[1,2],[1,3],[1,4],[1,5],[1,6],
      [2,1],[2,2],[2,3],[2,-1],[2,-2],[2,-3],
      [3,1],[3,2],[3,-1],[3,-2],
      [4,1],[4,-1],[5,1],[5,-1],[6,1],[6,-1]
    ];
    const pair = validPairs[Math.floor(Math.random()*validPairs.length)];
    a1=pair[0]; a2=pair[1]; a=a1*a2;
    m=getRandom(-20,20); n=getRandom(-20,20); b=a2*m + a1*n; c=m*n;
    displayProblem();

    greatestCommonFactor = getGCF(Math.abs(m), Math.abs(a1));
    m/=greatestCommonFactor; a1/=greatestCommonFactor;
    if(m%a1===0) correctAnswer1=-m/a1;
    else correctAnswer1=(m/a1>0 ? '-' : '')+Math.abs(m)+'/'+Math.abs(a1);

    greatestCommonFactor = getGCF(Math.abs(n), Math.abs(a2));
    n/=greatestCommonFactor; a2/=greatestCommonFactor;
    if(n%a2===0) correctAnswer2=-n/a2;
    else correctAnswer2=(n/a2>0 ? '-' : '')+Math.abs(n)+'/'+Math.abs(a2);
}

// DISPLAY
function displayProblem() {
    var problem = 'Solve for all possible values of the variable.<br />Simplify fractions completely.<br /><br>';
    
    // display a properly, especially if a = 1 or -1
    if (a===1) {problem += '';}
    else if (a===-1) {problem += '&ndash;';}
    else {problem += a;}
    problem += 'x<sup>2</sup> ';
    
    // display b properly, especially if b is pos, neg, 1, -1, or 0
    if (b===0) {problem += '';}
    else {
      if (b>0) {
        problem += '+';
        if (b===1) {problem += '';}
        else {problem += b;}
      }
      else {
        problem += '&ndash; ';
        if (b===-1) {problem += '';}
        else {problem += Math.abs(b);}
      }
      problem += 'x ';
    }
    
    // display c properly, especially if c is neg or zero
    if (c===0) {problem += '';}
    else if (c < 0) {problem += '&ndash; ' + Math.abs(c);}
    else {problem += '+ ' + c;}
    
    problem += ' = 0';
    problem += '&nbsp;&nbsp;&nbsp&nbsp;&nbsp;(Hint: b<sup>2</sup> &ndash; 4ac = ';
    problem += b*b-4*a*c + ')';
    
    document.getElementById('problemDiv').innerHTML = problem;
} // end of displayProblem()

function getNewProblemDisplay() {
    document.getElementById('newButton').style.visibility='hidden';
    document.getElementById('answerInput1').value='';
    document.getElementById('answerInput2').value='';
    document.getElementById('feedbackDiv').innerHTML='&nbsp;';
    document.getElementById('checkButton').style.display='inline';
    document.getElementById('answerInput1').style.display='inline';
    document.getElementById('answerInput2').style.display='inline';
    document.getElementById('orSpan').style.display='inline';
    document.getElementById('errorDiv').style.visibility='hidden';
}

// RANDOM NUMBER
function getRandom(min,max){return Math.floor(Math.random()*(max-min+1))+min;}

// CHECK ANSWER
function checkAnswer(){
    if(document.getElementById('answerInput1').value!=='' && document.getElementById('answerInput2').value!==''){
        document.getElementById('errorDiv').style.visibility='hidden';
        document.getElementById('checkButton').style.display='none';

        if(firstAttempt){
            var userAnswer1=document.getElementById('answerInput1').value;
            var userAnswer2=document.getElementById('answerInput2').value;

            if(correctAnswer1==userAnswer2 && correctAnswer2==userAnswer1){
                var temp=userAnswer2; userAnswer2=userAnswer1; userAnswer1=temp;
            }

            if(userAnswer1==correctAnswer1 && userAnswer2==correctAnswer2){
                result='correct'; jumpSafe(); reset=false; numCorrect++;
            } else {
                result='incorrect'; jumpFail(); reset=true; numCorrect=0;
            }
        }

        firstAttempt=false;
    } else {
        document.getElementById('errorDiv').style.visibility='visible';
        document.getElementById('answerInput1').focus();
    }
}

// FEEDBACK
function giveFeedback(){
    if(result==='correct') document.getElementById('feedbackDiv').innerHTML='<br />Correct!';
    else if(result==='incorrect')
        document.getElementById('feedbackDiv').innerHTML='<br />Correct answer: '+correctAnswer1+' or '+correctAnswer2+'<br />Try again!';
    document.getElementById('newButton').style.visibility='visible';
    document.getElementById('newButton').focus();
}

function getStats() {
    if (numberAttempted === 0) {
        percentCorrect = '';
    } else {
        percentCorrect = roundDecimalNumber(
            100 * numberCorrect / numberAttempted, 1
        );
    }

    var statsText = 'Level: ' + level + '<br />';
    statsText += 'Attempted: ' + numberAttempted + '<br />';
    statsText += 'Correct: ' + numberCorrect + '<br />';

    if (numberAttempted > 0) {
        statsText += 'Percent: ' + percentCorrect + '%';
    }

    document.getElementById('statsDiv').innerHTML = statsText;
} // end of getStats()

// ROUND DECIMAL
function roundDecimalNumber(number,places){
    number = number*Math.pow(10,places);
    number = number.toFixed(0);
    number = number/Math.pow(10,places);
    return number;
}
function startCelebrationBounce() {
    if (celebrateID) return;

    var animate = document.getElementById("animate");
    var baseBottom = parseFloat(animate.style.bottom) || START_BOTTOM;
    var bounceHeight = 18;
    var frames = 24;
    var frameTime = 18;
    var t = 0;
    var direction = 1;

    celebrateID = setInterval(function () {
        var p = t / frames;
        var eased = 1 - Math.pow(1 - p, 2);

        if (direction === 1) {
            animate.style.bottom =
                (baseBottom + eased * bounceHeight) + "px";
        } else {
            animate.style.bottom =
                (baseBottom + (1 - eased) * bounceHeight) + "px";
        }

        t++;
        if (t > frames) {
            t = 0;
            direction = -direction;
        }
    }, frameTime);
} // end of startCelebrationBounce()

function stopCelebrationBounce() {
    if (celebrateID) {
        clearInterval(celebrateID);
        celebrateID = null;
        resetPosition();
    }
} // end of stopCelebrationBounce()

</script>

<body onload="loadPage()">
  <h3>Quadratic Formula (Moderate difficulty)</h3>
  <div id="container">
    <button id="newButton" onclick="newProblem()">New problem</button>
    <br /><br />
    <span id="problemDiv">Click the button above to get a new problem</span>
    <br /><br />
    <input type="text" id="answerInput1" style="width:50px;" />
    <span id="orSpan"> or </span>
    <input type="text" id="answerInput2" style="width:50px;" />
    <button id="checkButton" onclick="checkAnswer();">Check answer</button>
    <div id="errorDiv" style="color:red; visibility:hidden;">Type or click an answer in the box</div>
    <span id="statsDiv">Stats</span>
    <span id="feedbackDiv">&nbsp;</span>
    <span id="floor1"></span>
    <span id="water1"></span>
    <span id="floor2"></span>
    <span id="water2"></span>
    <span id="floor3"></span>
    <span id="water3"></span>
    <span id="floor4"></span>
    <span id="animate"><img src="../images/wolf transparent.png" style="width:150%; height:150%"></span>
  </div>
</body>
</html>
